<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Игровой тренажёр слов с картинками</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">

<style>
/* Box-sizing everywhere to avoid overflow surprises */
*{box-sizing:border-box}
:root{
  --bg1:#74ebd5; --bg2:#ACB6E5;
  --accent:#74b9ff; --accent-dark:#3b8ed9;
  --success:#55efc4; --danger:#ff7675;
  --card-bg: rgba(255,255,255,0.96);
  --radius:12px;
  --tap-size:48px;
  --max-width:1200px;
}

/* BASE */
html,body{height:100%;margin:0;padding:0;font-family:'Comic Neue','Luckiest Guy',cursive,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
body{display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:12px;overflow:hidden}
.container{
  width:100%;
  max-width:var(--max-width);
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:12px;
  min-height:calc(100vh - 24px);
  padding:8px;
}

/* Left / Right columns (used in landscape) */
.left-column, .right-column{
  width:100%;
  min-height:0;
  overflow-y: auto;
}

/* header and status */
h1{margin:0;color:#fff;font-size:1.9rem;text-shadow:2px 2px 6px rgba(0,0,0,0.45);text-align:center;padding:6px}
.topRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:0}
#score,#timer{font-size:1rem;color:#fff;text-shadow:1px 1px 4px rgba(0,0,0,0.5);padding:6px 10px;border-radius:10px;background:rgba(0,0,0,0.12)}

/* cards */
.card{border-radius:var(--radius);padding:14px;background:var(--card-bg);box-shadow:0 6px 12px rgba(0,0,0,0.18);font-size:1rem;text-align:center}
#question{display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:auto;min-height:120px;padding:12px}

/* image - fixed small size */
img.wordImage {
  width:120px;
  height:120px;
  object-fit:contain;
  border-radius:10px;
  margin-bottom:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.18);
  display:block;
  flex-shrink:0;
}

/* options default (portrait) */
#options {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(140px,1fr));
  gap:10px;
  width:100%;
  margin:0 auto;
  padding:10px;
  background:transparent;
  border-radius:var(--radius);
}

/* buttons */
button {
  -webkit-tap-highlight-color: transparent;
  min-height:var(--tap-size);
  padding:10px 12px;
  margin:0;
  border:none;
  border-radius:10px;
  background:var(--accent);
  color:#fff;
  font-weight:700;
  cursor:pointer;
  font-size:1rem;
  text-shadow:0 1px 1px rgba(0,0,0,0.15);
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  user-select:none;
}
button:active{transform:translateY(1px)}
button[disabled]{opacity:0.5;cursor:not-allowed}
button.correct{background:var(--success); color:#054b2f}
button.wrong{background:var(--danger); color:#5a130f}

/* controls */
#gameControls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
#startBtn,#restartBtn{min-width:120px}

/* fixed file status and modal button */
#openLoadModal{position:fixed;top:12px;right:12px;padding:10px 14px;font-size:0.95rem;border-radius:10px;background:#fd79a8;color:#fff;border:none;cursor:pointer;z-index:1000}
#fileStatus{position:fixed;top:12px;left:12px;background:var(--card-bg);padding:8px 10px;border-radius:8px;box-shadow:0 3px 8px rgba(0,0,0,0.15);font-size:0.9rem;z-index:1000}

/* MODAL */
#loadModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);justify-content:center;align-items:center;z-index:999;padding:20px;box-sizing:border-box}
#loadModal .modalContent{background:#fff;padding:16px;border-radius:12px;text-align:center;max-width:440px;width:100%;box-shadow:0 8px 20px rgba(0,0,0,0.25)}
.modalRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:8px 0}

/* RESULT MODAL */
#resultModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:1001;padding:20px}
#resultModal .modalContent{background:#fff;padding:16px;border-radius:12px;text-align:center;max-width:360px;width:100%;}

/* NOTICE / TOAST */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.8);color:#fff;padding:10px 14px;border-radius:10px;z-index:1100;font-size:0.95rem;opacity:0;pointer-events:none;transition:opacity .28s ease}
.toast.show{opacity:1;pointer-events:auto}

/* UTILITY */
.small{font-size:0.85rem;color:#444}
.notice{background:#fff3b0;color:#6b4a00;padding:8px;border-radius:8px;margin-top:8px;font-size:0.95em}
label{display:block;margin:8px 0 4px;color:#fff;text-align:center;font-weight:600}

/* Portrait small tweaks */
@media (max-width:420px){
  h1{font-size:1.45rem}
  .card{padding:12px}
  button{font-size:0.95rem;padding:10px}
  #fileStatus{font-size:0.82rem;padding:6px}
}

/* LANDSCAPE: two columns (in wide mode) */
@media (orientation: landscape) and (min-width:640px) {

  .container{
    display:grid;
    grid-template-columns: minmax(320px, 1fr) 380px;
    grid-template-rows: auto auto minmax(0, 1fr) auto; /* КЛЮЧЕВО */
    height:100vh;
    min-height:100vh;
    max-height:100vh;
    gap:12px;
    padding:12px;
  }

  .left-column{
    grid-column:1 / 2;
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:hidden;          /* важно */
    padding-right:6px;
    min-height:0;
  }

  .right-column{
    grid-column:2 / 3;
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:hidden;          /* важно */
    padding-left:6px;
    min-height:0;
  }

  h1{
    grid-column:1 / 3;
    align-self:start;
  }

  .topRow{
    grid-column:1 / 3;
    justify-content:flex-start;
  }

  #question{
    flex:1;
    min-height:0;
    padding:18px;
    justify-content:flex-start;
  }

  /* options buttons: 2x2 grid, smaller font */
  #options{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:10px;
    padding:12px 18px;
  }

  #options button{
    font-size:0.95rem;
    min-height:48px;
    padding:10px;
    text-align:center;
  }

  #gameControls{
    grid-column:1 / 2;
    align-self:end;
    justify-self:start;
    padding:12px;
    background:var(--card-bg);
    border-radius:var(--radius);
    box-shadow:0 6px 12px rgba(0,0,0,0.12);
  }

  select#difficulty,
  input[type=number]{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.08);
    font-size:1rem;
  }

  /* fixed small image */
  img.wordImage{
    width:120px;
    height:120px;
    object-fit:contain;
    border-radius:10px;
    margin-bottom:12px;
    box-shadow:0 4px 10px rgba(0,0,0,0.18);
    flex-shrink:0;
  }
}


/* hide "Загрузить JSON" and file status on small screens (mobile) */
@media (max-width:639px){
  #openLoadModal, #fileStatus { display:none !important; }
}

/* show/hide helpers (no layout change, just visibility) */
.hidden-ui { display:none !important; }

/* Полностью скрываем загрузку JSON и статус файлов */
#openLoadModal,
#fileStatus {
  display: none !important;
}
</style>

</head>
<body>
  <div class="container" role="main">
    <h1 id="pageTitle">Игра: Найди правильное слово</h1>

    <div class="topRow" aria-hidden="false">
      <div id="score" aria-live="polite">Очки: 0 | Комбо: 1</div>
      <div id="timer" aria-live="polite">Время: 10</div>
    </div>

    <!-- ЛЕВАЯ КОЛОНКА -->
    <div class="left-column">
      <!-- пометил label id для удобного скрытия -->
      <label id="difficultyLabel" for="difficulty">Выберите уровень сложности:</label>
      <select id="difficulty" class="card" style="text-align:center;">
        <option value="easy">Лёгкий</option>
        <option value="medium">Средний</option>
        <option value="hard">Сложный</option>
      </select>

      <div id="question" class="card" aria-live="polite"></div>

      <!-- Обернул блок диапазона в отдельный div с id -->
      <div id="rangeControls" style="margin-top:6px;text-align:center;">
        <label for="sentenceLimit" class="small" style="color:#fff">Диапазон предложений (начало / конец)</label>
        <div class="modalRow" style="justify-content:center; gap:8px; margin-top:6px;">
          <input type="number" id="sentenceStart" value="1" min="1" placeholder="С" style="width:110px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)">
          <input type="number" id="sentenceEnd" value="9999" min="1" placeholder="По" style="width:110px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)">
        </div>
		<div id="sentenceTotal" class="small"></div>
      </div>
	  
    </div>

    <!-- ПРАВАЯ КОЛОНКА -->
    <div class="right-column">
      <div id="options" aria-label="Варианты ответов" class="card"></div>

      <div id="gameControls" class="card" style="display:flex;justify-content:center;align-items:center;">
        <button id="startBtn" aria-pressed="false" disabled>Начать игру</button>
        <button id="restartBtn" style="display:none;">Начать новую игру</button>
      </div>
    </div>
  </div>

  <button id="openLoadModal" aria-haspopup="dialog">Загрузить JSON</button>

  <div id="fileStatus" aria-hidden="false">
    words: <span id="wordsName">word.json</span><br>
    sentences: <span id="sentName">sentences.json</span>
  </div>

  <!-- LOAD MODAL -->
  <div id="loadModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modalContent">
      <h2>Загрузить JSON-файлы</h2>
      <div class="small" style="margin-bottom:8px">По умолчанию — <strong>word.json</strong> и <strong>sentences.json</strong>. Автозагрузка возможна при размещении на сервере; при открытии по <code>file://</code> используйте ручную загрузку.</div>

      <div class="modalRow">
        <button id="loadFromFolder">Загрузить из папки (fetch)</button>
        <button id="loadDefault">Загрузить пример</button>
      </div>

      <div style="margin-top:8px">
        <div class="small">Или выберите вручную:</div>
        <input id="wordsFile" type="file" accept=".json" style="margin-top:8px"><br>
        <input id="sentFile" type="file" accept=".json" style="margin-top:8px"><br>
      </div>

      <div style="margin-top:10px">
        <button id="closeModal">Закрыть</button>
      </div>

      <div id="autoLoadHint" class="notice" style="display:none;margin-top:12px"></div>
      <div class="small" style="margin-top:8px;color:#666">После загрузки обоих файлов кнопка "Начать игру" станет активной.</div>
    </div>
  </div>

  <!-- RESULT MODAL -->
  <div id="resultModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modalContent">
      <h3>Игра окончена</h3>
      <div id="resultText" class="small" style="margin:8px 0"></div>
      <div style="margin-top:10px">
        <button id="closeResult">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ======== ДАННЫЕ ======== */
let words = [], sentences = [];
let remainingWords = [], remainingSentences = [];
let score = 0, combo = 1;
let correctCount = 0, wrongCount = 0, skippedCount = 0;
let answerTimeout = null, timePerWordInterval = null;
let currentWord = null;

let wordsLoaded = false, sentencesLoaded = false;
let wordsFileName = 'word.json', sentencesFileName = 'sentences.json';

/* POS mapping (оставил ваш словарь) */
const posNames = {
  noun:"Substantiv", verb:"Verbum", adj:"Adjektiv", adv:"Adverbium",
  pron:"Pronomen", prep:"Præposition", conj:"Konjunktion", interj:"Interjektion",
  num:"Numeral", art:"Artikel", aux:"Hilfsverb", part:"Partikel",
  det:"Determinativ", modal:"Modalverbum", poss:"Possessivpronomen", reflex:"Refleksivpronomen"
};

/* ======= UI HELPERS ======= */
const toastEl = document.getElementById('toast');
function showToast(msg, ms = 2000){
  if(!toastEl) return;
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>{ toastEl.classList.remove('show'); }, ms);
}

function openModal(modal){
  if(!modal) return;
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
}
function closeModal(modal){
  if(!modal) return;
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
}

/* ======= Примеры данных (по-умолчанию) ======= */
function loadDefaultData(){
  words = [
    {id:"w1", word:"hus", value:"дом", pos:"noun", imageUrl:"hus.jpg"},
    {id:"w2", word:"kat", value:"кот", pos:"noun", imageUrl:"kat.jpg"},
    {id:"w3", word:"løbe", value:"бежать", pos:"verb"},
    {id:"w4", word:"stol", value:"стул", pos:"noun"},
    {id:"w5", word:"grøn", value:"зелёный", pos:"adj"},
    {id:"w6", word:"vand", value:"вода", pos:"noun"}
  ];
  sentences = [
    {id:"s1", wordId:"w1","text":"Jeg bor i et lille {{word}}."},
    {id:"s2", wordId:"w2","text":"{{word}} sover på sofaen."},
    {id:"s3", wordId:"w3","text":"Han kan {{word}} hurtigt."},
    {id:"s4", wordId:"w4","text":"Sæt dig på en anden {{word}}."},
    {id:"s5", wordId:"w5","text":"Himlen er {{word}} i dag."}
  ];
  wordsLoaded = true; sentencesLoaded = true;
  wordsFileName = 'пример'; sentencesFileName = 'пример';
  updateFileStatus();
  checkStartButton();
  updateSentenceTotal();
}

/* ======= UI STATUS ======= */
function updateFileStatus(){
  const wEl = document.getElementById('wordsName');
  const sEl = document.getElementById('sentName');
  if (wEl) wEl.textContent = wordsFileName || '—';
  if (sEl) sEl.textContent = sentencesFileName || '—';
}

// UI: показать общее количество предложений
function updateSentenceTotal(){
  const el = document.getElementById('sentenceTotal');
  if (!el) return;

  const total = Array.isArray(sentences) ? sentences.length : 0;
  el.textContent = `Всего предложений: ${total}`;
}


function checkStartButton(){
  const startBtn = document.getElementById('startBtn');
  if (startBtn) startBtn.disabled = !(wordsLoaded && sentencesLoaded);
}
function showScore(){
  const scoreEl = document.getElementById('score');
  if (scoreEl) scoreEl.textContent = `Очки: ${score} | Комбо: ${combo} | ✅ ${correctCount} ❌ ${wrongCount} ⏭ ${skippedCount}`;
}

/* ======= HELPERS ======= */
function shuffleArray(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}
function resetRemainingWords(){
  remainingWords = words.slice();
  shuffleArray(remainingWords);
}
function resetRemainingSentences(){
  remainingSentences = sentences.slice();
  const startEl = document.getElementById('sentenceStart'), endEl = document.getElementById('sentenceEnd');
  let start = 0, end = remainingSentences.length;
  if (startEl) {
    const s = parseInt(startEl.value, 10);
    if (!isNaN(s) && s >= 1 && s <= remainingSentences.length) start = s - 1;
  }
  if (endEl) {
    const e = parseInt(endEl.value, 10);
    if (!isNaN(e) && e >= start + 1 && e <= remainingSentences.length) end = e;
  }
  remainingSentences = remainingSentences.slice(start, end);
  shuffleArray(remainingSentences);
}

/* ======= LOADING JSON (fetch + FileReader) ======= */
async function fetchJsonUrl(url){
  try{
    const r = await fetch(url, {cache: 'no-cache'});
    if(!r.ok) throw new Error('HTTP ' + r.status);
    return await r.json();
  }catch(e){
    console.warn('fetch error', url, e);
    return null;
  }
}
function normalizeBasePath(p){
  if(!p) return '';
  p = p.trim();
  if(p.startsWith('http://') || p.startsWith('https://') || p.startsWith('/')){
    if(!p.endsWith('/')) p += '/';
    return p;
  }
  if(!p.endsWith('/')) p += '/';
  return p;
}
async function loadFilesFromFolder(basePath = ''){
  const hint = document.getElementById('autoLoadHint');
  if (hint) hint.style.display = 'none';
  const bp = normalizeBasePath(basePath);
  const wordsUrl = bp + 'word.json';
  const sentUrl  = bp + 'sentences.json';
  const wordsDataPromise = wordsLoaded ? Promise.resolve(words) : fetchJsonUrl(wordsUrl);
  const sentDataPromise  = sentencesLoaded ? Promise.resolve(sentences) : fetchJsonUrl(sentUrl);
  const [wordsData, sentData] = await Promise.all([wordsDataPromise, sentDataPromise]);

  if (!wordsLoaded && Array.isArray(wordsData)) {
    words = wordsData; wordsLoaded = true; wordsFileName = wordsUrl;
    console.log('word.json загружен:', wordsUrl);
  }
  if (!sentencesLoaded && Array.isArray(sentData)) {
    sentences = sentData; sentencesLoaded = true; sentencesFileName = sentUrl;
    console.log('sentences.json загружен:', sentUrl);
  }
  updateFileStatus(); checkStartButton(); updateSentenceTotal();

  if (!(wordsLoaded && sentencesLoaded)) {
    if (hint) {
      hint.style.display = 'block';
      hint.innerHTML = `Не удалось загрузить файлы по адресам:<br><code>${wordsUrl}</code><br><code>${sentUrl}</code><br>Проверьте путь, CORS или статус в DevTools.`;
    }
    openModal(document.getElementById('loadModal'));
  } else {
    if (hint) {
      hint.style.display = 'block';
      hint.textContent = 'Файлы загружены — можно начать игру.';
      setTimeout(()=>{ if(hint) hint.style.display = 'none'; }, 1800);
    }
  }
}

/* FILE INPUTS */
const wordsFileInput = document.getElementById('wordsFile');
if (wordsFileInput){
  wordsFileInput.addEventListener('change', e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      try{
        const parsed = JSON.parse(ev.target.result);
        if(!Array.isArray(parsed)) throw new Error('word.json должен быть массивом объектов');
        words = parsed; wordsLoaded = true; wordsFileName = file.name;
        updateFileStatus(); checkStartButton();
        showToast('word.json успешно загружен: ' + file.name);
      }catch(err){
        wordsLoaded = false; wordsFileName = '';
        updateFileStatus(); checkStartButton();
        showToast('Ошибка чтения word.json');
        console.error(err);
      }
    };
    reader.readAsText(file, 'utf-8');
  }, {passive:true});
}

const sentFileInput = document.getElementById('sentFile');
if (sentFileInput){
  sentFileInput.addEventListener('change', e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      try{
        const parsed = JSON.parse(ev.target.result);
        if(!Array.isArray(parsed)) throw new Error('sentences.json должен быть массивом объектов');
        sentences = parsed; sentencesLoaded = true; sentencesFileName = file.name;
        updateFileStatus(); checkStartButton(); updateSentenceTotal();
        showToast('sentences.json успешно загружен: ' + file.name);
      }catch(err){
        sentencesLoaded = false; sentencesFileName = '';
        updateFileStatus(); checkStartButton();
        showToast('Ошибка чтения sentences.json');
        console.error(err);
      }
    };
    reader.readAsText(file, 'utf-8');
  }, {passive:true});
}

/* MODAL CONTROLS */
const loadFromFolderBtn = document.getElementById('loadFromFolder');
if (loadFromFolderBtn) loadFromFolderBtn.addEventListener('click', ()=>{
  loadFilesFromFolder('');
}, {passive:true});

const loadDefaultBtn = document.getElementById('loadDefault');
if (loadDefaultBtn) loadDefaultBtn.addEventListener('click', ()=>{
  loadDefaultData();
  showToast('Пример загружен');
  closeModal(document.getElementById('loadModal'));
}, {passive:true});

const openModalBtn = document.getElementById('openLoadModal');
const loadModal = document.getElementById('loadModal');
const closeModalBtn = document.getElementById('closeModal');
if (openModalBtn) openModalBtn.addEventListener('click', ()=> openModal(loadModal), {passive:true});
if (closeModalBtn) closeModalBtn.addEventListener('click', ()=> closeModal(loadModal), {passive:true});
window.addEventListener('click', e=>{ if(loadModal && e.target===loadModal) closeModal(loadModal); }, {passive:true});

/* GAME CONTROLS */
const startBtn = document.getElementById('startBtn');
const restartBtn = document.getElementById('restartBtn');
if (startBtn) startBtn.disabled = true;

/* UI show/hide helpers requested by user */
const pageTitle = document.getElementById('pageTitle');
const difficultyLabel = document.getElementById('difficultyLabel');
const difficultySelect = document.getElementById('difficulty');
const rangeControls = document.getElementById('rangeControls');

function hideUIOnPlay(){
  // hide title, difficulty and range controls
  if(pageTitle) pageTitle.classList.add('hidden-ui');
  if(difficultyLabel) difficultyLabel.classList.add('hidden-ui');
  if(difficultySelect) difficultySelect.classList.add('hidden-ui');
  if(rangeControls) rangeControls.classList.add('hidden-ui');
  // also hide modal button + file status on small screens already handled by CSS
}

function restoreUI(){
  if(pageTitle) pageTitle.classList.remove('hidden-ui');
  if(difficultyLabel) difficultyLabel.classList.remove('hidden-ui');
  if(difficultySelect) difficultySelect.classList.remove('hidden-ui');
  if(rangeControls) rangeControls.classList.remove('hidden-ui');
}

/* Attach start/restart handlers — keep game logic unchanged but toggle UI */
if (startBtn) startBtn.addEventListener('click', ()=>{
  // hide requested UI elements when starting the game
  hideUIOnPlay();

  startGame();
  startBtn.style.display = 'none';
  restartBtn.style.display = 'inline-block';
  closeModal(loadModal);
}, {passive:true});

if (restartBtn) restartBtn.addEventListener('click', () => {
  endGame();  // при нажатии просто вызываем функцию окончания игры
}, {passive:true});

/* Stop and clear timers cleanly */
function stopTimers(){
  if(answerTimeout) { clearInterval(answerTimeout); answerTimeout = null; }
  if(timePerWordInterval) { clearInterval(timePerWordInterval); timePerWordInterval = null; }
}

/* GAME FLOW */
function startGame(){
  // показать контейнеры для игры
  const questionEl = document.getElementById('question');
  const optionsEl = document.getElementById('options');
  if(questionEl) questionEl.style.display = 'flex';
  if(optionsEl) optionsEl.style.display = 'grid';

  // скрыть стартовую кнопку
  const startBtnEl = document.getElementById('startBtn');
  if (startBtnEl) startBtnEl.style.display = 'none';

  // скрыть элементы выбора уровня
  hideUIOnPlay();

  // сброс счетчиков и состояний
  score = 0; combo = 1;
  correctCount = 0; wrongCount = 0; skippedCount = 0;
  showScore();
  resetRemainingSentences(); resetRemainingWords();

  // запускаем первый вопрос
  nextQuestion();
}


function pickWord(){ return remainingWords.length>0 ? remainingWords.pop() : null; }
function pickSentence(){ return remainingSentences.length>0 ? remainingSentences.pop() : null; }

function makeOptions(correct){
  const opts = [correct];
  let candidates = words.filter(w => w.id !== correct.id);
  while(opts.length < 4 && candidates.length > 0){
    let idx = Math.floor(Math.random() * candidates.length);
    opts.push(candidates.splice(idx,1)[0]);
  }
  for(let i = opts.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [opts[i], opts[j]] = [opts[j], opts[i]];
  }
  return opts;
}
function endGame(){
  stopTimers();

  // Скрываем игровые элементы (вопрос, картинки, варианты)
  const questionEl = document.getElementById('question');
  const optionsEl = document.getElementById('options');
  if(questionEl) questionEl.style.display = 'none';
  if(optionsEl) optionsEl.style.display = 'none';

  // disable option buttons
  document.querySelectorAll('#options button').forEach(b => b.disabled = true);

  // show result modal
  const resultText = document.getElementById('resultText');
  if(resultText) resultText.innerHTML = `
    Правильных: <strong>${correctCount}</strong><br>
    Неправильных: <strong>${wrongCount}</strong><br>
    Пропущенных: <strong>${skippedCount}</strong><br>
    Очки: <strong>${score}</strong>
  `;
  openModal(document.getElementById('resultModal'));

  // restore UI (выбор уровня и прочее)
  restoreUI();

  // показать только стартовую кнопку
  const startBtnEl = document.getElementById('startBtn');
  if(startBtnEl) startBtnEl.style.display = 'inline-block';

  // спрятать кнопку "Начать новую игру"
  const restartBtnEl = document.getElementById('restartBtn');
  if(restartBtnEl) restartBtnEl.style.display = 'none';
}

// Кнопка "Начать новую игру" теперь просто завершает текущую игру
if (restartBtn) restartBtn.addEventListener('click', ()=>{
  endGame();
}, {passive:true});


/* when result closed */
const closeResultBtn = document.getElementById('closeResult');
if (closeResultBtn) closeResultBtn.addEventListener('click', ()=> closeModal(document.getElementById('resultModal')), {passive:true});

/* QUESTION / OPTIONS (unchanged) */
function nextQuestion(){
  stopTimers();

  if(!words.length || !sentences.length){
    const qEl = document.getElementById('question');
    if (qEl) qEl.innerHTML = '<div class="small">Сначала загрузите файлы или пример.</div>';
    return;
  }

  const sentenceObj = pickSentence();
  if(!sentenceObj){ endGame(); return; }

  currentWord = words.find(w => w.id === sentenceObj.wordId);
  if(!currentWord){
    // если слово не найдено — перейдём к следующему
    if(remainingSentences.length === 0){ endGame(); return; }
    else { setTimeout(nextQuestion, 0); return; }
  }

  const sentenceText = sentenceObj.text ? sentenceObj.text.replace("{{word}}","_____") : "_____";
  const typeWord = posNames[currentWord.pos] || "Ord";

  let qHtml = "";
  if(currentWord.imageUrl){
    // loading=lazy + decoding=async для быстроты и экономии трафика
    qHtml += `<div style="margin-bottom:8px;"><img class="wordImage" src="${currentWord.imageUrl}" alt="Изображение: ${currentWord.word}" loading="lazy" decoding="async"></div>`;
  }

  const difficultyEl = document.getElementById('difficulty');
  const difficulty = difficultyEl ? difficultyEl.value : 'hard';
  qHtml += `<div style="margin-top:8px;"><strong>Найди слово</strong><br>${sentenceText}</div>`;
  if(difficulty === "easy") qHtml += `<br><em>Тип слова: ${typeWord}</em><br><span class="small">Перевод: ${currentWord.value || '-'}</span>`;
  else if(difficulty === "medium") qHtml += `<br><em>Тип слова: ${typeWord}</em>`;

  const questionEl = document.getElementById('question');
  if (questionEl) questionEl.innerHTML = qHtml;

  const optionsDiv = document.getElementById('options');
  if (optionsDiv) {
    optionsDiv.innerHTML = '';
    makeOptions(currentWord).forEach(o => {
      let btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = o.word;
      btn.setAttribute('aria-label', 'Вариант: ' + o.word);
      btn.addEventListener('click', ()=> { stopTimers(); checkAnswer(o, btn); }, {passive:true});
      optionsDiv.appendChild(btn);
    });
  }

  // Таймер на вопрос — показываем в блоке timer
  let timeLeft = 10;
  const timerEl = document.getElementById('timer');
  if (timerEl) timerEl.textContent = `Время: ${timeLeft}`;

  answerTimeout = setInterval(()=>{
    timeLeft--;
    if (timerEl) timerEl.textContent = `Время: ${timeLeft}`;
    if(timeLeft <= 0){
      clearInterval(answerTimeout); answerTimeout = null;
      document.querySelectorAll('#options button').forEach(b => b.disabled = true);
      skippedCount++;
      showScore();
      if(!remainingSentences || remainingSentences.length === 0) setTimeout(endGame, 500);
      else setTimeout(nextQuestion, 500);
    }
  }, 1000);
}

function checkAnswer(selected, btn){
  // disable buttons
  document.querySelectorAll('#options button').forEach(b => b.disabled = true);

  if(selected.id === currentWord.id){
    if (btn) btn.classList.add('correct');
    correctCount++;
    score += 10 * combo;
    combo++;
  } else {
    if (btn) btn.classList.add('wrong');
    wrongCount++;
    combo = 1;
  }

  showScore();

  if(!remainingSentences || remainingSentences.length === 0) setTimeout(endGame, 800);
  else setTimeout(nextQuestion, 700);
}

/* ========== INIT ========== */
updateFileStatus();
checkStartButton();

/* Автозагрузка при открытии (если доступны файлы на сервере) */
window.addEventListener('DOMContentLoaded', ()=>{ loadFilesFromFolder(''); }, {passive:true});
</script>
</body>
</html>
