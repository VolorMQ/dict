<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FlashDialogs</title>
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
<style>
/* ===== –û–°–ù–û–í–ê ===== */
body {
  margin: 0; 
  padding: 0;
  font-family: 'Comic Neue', cursive;
  min-height: 100vh; 
  overflow: hidden;
  position: relative;

  /* üé® –¢—ë–º–Ω—ã–π –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π —Ñ–æ–Ω */
  background: linear-gradient(
    135deg,
    #2e1a3f,
    #3a1f2c,
    #1f2a3a,
    #1f3a2c,
    #3a1f1f
  );
  background-size: 1200% 1200%;
  animation: darkPastelBG 90s ease infinite, brightnessPulse 60s ease-in-out infinite;
}

/* –ø–ª–∞–≤–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
@keyframes darkPastelBG {
  0%   { background-position: 0% 50%; }
  25%  { background-position: 50% 100%; }
  50%  { background-position: 100% 50%; }
  75%  { background-position: 50% 0%; }
  100% { background-position: 0% 50%; }
}

@keyframes brightnessPulse {
  0%   { filter: brightness(0.85); }
  50%  { filter: brightness(1.0); }
  100% { filter: brightness(0.85); }
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  background: radial-gradient(
    ellipse at 30% 30%, 
    rgba(255,255,255,0.05), 
    rgba(0,0,0,0.3)
  );
  animation: lightBreath 70s ease-in-out infinite;
  z-index: 0;
}

@keyframes lightBreath {
  0%   { opacity: 0.2; }
  50%  { opacity: 0.3; }
  100% { opacity: 0.2; }
}

/* ===== –õ–ï–¢–ê–Æ–©–ò–ï –°–õ–û–í–ê ===== */
.particle {
  position: absolute;
  font-weight: bold;
  text-align: center;
  pointer-events: none;
  user-select: none;
  font-size: clamp(2rem, 6vw, 4rem);
  background: linear-gradient(45deg, #ff9a9e,#fad0c4,#ffd700,#6fd6ff,#ff6f61);
  background-size: 400% 400%;
  animation: gradientText 5s ease infinite;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow:0 0 10px rgba(0,0,0,0.6);
  transition:left 3s ease, top 3s ease;
  padding: 18px;
  border-radius: 12px;
  z-index: 10;
}

/* —Ç–æ–∫–µ–Ω—ã –¥–∞—Ç—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä—É—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç —Ä–æ–¥–∏—Ç–µ–ª—è) */
.da-token {
  display: inline-block;
  white-space: pre;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  transition: transform 120ms ease, text-shadow 120ms ease;
}

/* –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞ (–¥–∞—Ç—Å–∫–æ–≥–æ) */
.da-token.highlight {
  -webkit-text-fill-color: #ffffff !important;
  color: #ffffff !important;
  -webkit-background-clip: initial !important;
  background: none !important;
  transform: translateY(-3px) scale(1.05);
  text-shadow: 0 0 14px rgba(255,215,0,0.95), 0 0 6px rgba(0,0,0,0.6);
  border-radius: 6px;
  padding: 2px 6px;
}

/* –º–∞–ª–µ–Ω—å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –ø–æ–¥ –¥–∞—Ç—Å–∫–∏–º —Ç–µ–∫—Å—Ç */
.translation {
  display:block;
  font-size:0.5em;
  margin-top:0.2em;
  color:#fff;
  text-shadow:0 0 6px rgba(0,0,0,0.9);
}

/* ===== –¶–ï–ù–¢–†–ê–õ–¨–ù–´–ï –ö–û–ù–¢–†–û–õ–´ ===== */
#controls {
  position: fixed;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
  flex-wrap: nowrap;
  z-index: 100;
}

/* ===== –ü–ê–ù–ï–õ–¨ –ó–ê–ì–†–£–ó–ö–ò –§–ê–ô–õ–ê –†–Ø–î–û–ú –° –ö–ù–û–ü–ö–ê–ú–ò ===== */
#dictionaryControls {
  position: fixed;
  bottom: 12px;
  left: calc(50% + 180px);
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
  z-index: 100;
  font-size: 0.85rem;
  color: #fff;
}

/* –ö–Ω–æ–ø–∫–∏ –∏ input */
#controls button,
#dictionaryControls button,
#dictionaryControls input {
  background: rgba(0,0,0,0.45);
  border: none;
  border-radius: 12px;
  padding: 8px 14px;
  color: #fff;
  font-size: 1rem;
  outline: none;
  text-align: center;
  white-space: nowrap;
}
#controls button:hover,
#dictionaryControls button:hover {
  background: rgba(0,0,0,0.65);
  cursor: pointer;
}

#controls input {
  background: rgba(0,0,0,0.45);
  border: none;
  border-radius: 12px;
  padding: 8px 10px;
  color: #fff;
  font-size: 1rem;
  outline: none;
  text-align: center;
  width: 140px;
}
#controls input::placeholder { color: #bbb; }

@media (max-width: 600px) {
  #controls { flex-wrap: wrap; justify-content: center; bottom: 72px; }
  #controls input { width: 120px; }
  #dictionaryControls { bottom: 96px; left: 50%; transform: translateX(-50%); }
}
@media (max-width: 420px) {
  #controls input { width: 100px; }
  #controls button,#dictionaryControls button,#dictionaryControls input { padding:6px 10px; font-size:0.9rem; }
}
@media (max-width: 360px) {
  #controls { bottom: 96px; }
  #dictionaryControls { bottom: 72px; left: 6px; gap:4px; font-size:0.8rem; }
}

#controls,
#dictionaryControls { visibility: visible; }

</style>
</head>
<body>

<div id="particleContainer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></div>

<!-- –ü–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div id="controls">
  <input id="stepInput" type="number" min="1" value="1" placeholder="N">
  <button id="stepBtn">OK</button>
  <button id="startBtn">–°—Ç–∞—Ä—Ç</button>
  <button id="stopBtn">–°—Ç–æ–ø</button>
</div>

<div id="dictionaryControls">
  <label><input type="file" id="localFileInput" accept=".json" style="width:90px"></label>
</div>

<script>
const MAX_REPEATS = 3; // –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
let dialogs = [];
let currentIndex = 0; // —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ª–æ–≥
let stepN = 1;        // —à–∞–≥ –ø–æ –¥–∏–∞–ª–æ–≥–∞–º
let showingSentence = false;
let sessionRunning = false;
let sessionStarted = false;
let sentenceIndex = 0; // —Ç–µ–∫—É—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥–µ

const PAUSE_MS_PER_SIGN = 50;

// ---------- TTS ----------

function cleanTextForTTS(text) {
  return text.replace(/[^a-zA-Z–∞-—è—ë–ê-–Ø–Å√¶√∏√•√Ü√ò√Ö\s]/g,'').trim();
}

function speak(text, lang, rate=1){
  return new Promise(resolve=>{
    const u = new SpeechSynthesisUtterance(cleanTextForTTS(text));
    u.lang = lang;
    u.rate = rate;
    u.onend = resolve;
    speechSynthesis.speak(u);
  });
}

// ---------- –î–∞—Ç—Å–∫–∏–π –≥–æ–ª–æ—Å —Å —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ–º ----------
let daVoices = [];
let lastDaVoice = 0; // –¥–ª—è —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏—è

function initVoices() {
  daVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith("da"));
  if(daVoices.length < 2){
    console.warn("–ú–µ–Ω—å—à–µ –¥–≤—É—Ö –¥–∞—Ç—Å–∫–∏—Ö –≥–æ–ª–æ—Å–æ–≤, –±—É–¥—É—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è");
  }
}

speechSynthesis.onvoiceschanged = initVoices;
initVoices();

async function speakDa(text, rate=1){
  if(daVoices.length === 0) return speak(text, "da-DK", rate); // fallback
  const voice = daVoices[lastDaVoice % daVoices.length];
  lastDaVoice = (lastDaVoice + 1) % daVoices.length;
  return new Promise(resolve=>{
    const u = new SpeechSynthesisUtterance(cleanTextForTTS(text));
    u.lang = "da-DK";
    u.voice = voice;
    u.rate = rate;
    u.onend = resolve;
    speechSynthesis.speak(u);
  });
}

// ---------- –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è (—Å–ª–æ–≤–∞ / –ø—É–Ω–∫—Ç—ã / –ø—Ä–æ–±–µ–ª—ã) ----------
function tokenizePreserve(text){
  // –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–ª–æ–≤–∞ (–ª–∞—Ç–∏–Ω—Å–∫–∏–µ –∏ —Å–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏–µ –±—É–∫–≤—ã), –≤—Å—ë –ø—Ä–æ—á–µ–µ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã, –∏ –ø—Ä–æ–±–µ–ª—ã –æ—Ç–¥–µ–ª—å–Ω–æ
  const re = /[A-Za-z√Ü√ò√Ö√¶√∏√•√Ä-√ñ√ò-√∂√∏-√ø]+|[^\sA-Za-z√Ü√ò√Ö√¶√∏√•√Ä-√ñ√ò-√∂√∏-√ø]+|\s+/g;
  const raw = text.match(re) || [];
  return raw.map(t => ({ text: t, isWord: /[A-Za-z√Ü√ò√Ö√¶√∏√•√Ä-√ñ√ò-√∂√∏-√ø]/.test(t) }));
}

function escapeHtml(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ---------- TTS —Å –ø–∞—É–∑–∞–º–∏ –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π (highlightCallback) ----------
async function speakWithPunctuationPauses(text, lang, rate=1, isDa=false, highlightCallback=null){
  if(!text?.trim()) return;
  const tokens = tokenizePreserve(text);
  let wordIndex = 0;
  for(const token of tokens){
    if(token.isWord){
      // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∞—Ç—Å–∫–æ–≥–æ)
      if(isDa && typeof highlightCallback === 'function') highlightCallback(wordIndex);
      if(isDa){
        await speakDa(token.text, rate);
      } else {
        await speak(token.text, lang, rate);
      }
      // —É–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ—Å–ª–µ –ø—Ä–æ–∏–∑–Ω–µ—Å–µ–Ω–∏—è —Å–ª–æ–≤–∞
      if(isDa && typeof highlightCallback === 'function') highlightCallback(null);
      wordIndex++;
    } else {
      // –Ω–µ-—Å–ª–æ–≤–æ: –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è –∏–ª–∏ –ø—Ä–æ–±–µ–ª
      if(/\s+/.test(token.text)){
        // –ø—Ä–æ–±–µ–ª—ã ‚Äî –∫–æ—Ä–æ—Ç–∫–∞—è –ø–∞—É–∑–∞ (–º–æ–∂–µ–º –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)
        // –Ω–µ–±–æ–ª—å—à–∞—è tiny pause
        await new Promise(r => setTimeout(r, 80));
      } else {
        // –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è ‚Äî –ø–∞—É–∑–∞ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∑–Ω–∞–∫–∞–º
        const signs = token.text.replace(/\s/g,'').length;
        if(signs > 0) await new Promise(r => setTimeout(r, PAUSE_MS_PER_SIGN * signs));
      }
    }
  }
}

// ---------- UI –ø–æ–∑–∏—Ü–∏–∏ ----------
function randomPosition(el){
  const topOffset = 12;
  const bottomControls = document.getElementById('controls');
  const bottomMenu = document.getElementById('dictionaryControls');
  const bottomLimit = Math.max(bottomControls.offsetHeight,bottomMenu.offsetHeight)+12;
  const containerHeight = window.innerHeight - el.offsetHeight - bottomLimit - topOffset;
  return { x: Math.random()*(window.innerWidth-el.offsetWidth), y: topOffset+Math.random()*Math.max(0,containerHeight) };
}

function moveTo(el,pos){ el.style.left=pos.x+'px'; el.style.top=pos.y+'px'; }

// ===== –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π –¥–∞—Ç—Å–∫–∏—Ö —Å–ª–æ–≤ =====
async function showSentence(sentence){
  showingSentence = true;
  const el = document.createElement('div');
  el.className = 'particle';
  el.style.position = 'absolute';

  // –†–∞–∑–±–∏–≤–∞–µ–º –¥–∞—Ç—Å–∫–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ç–æ–∫–µ–Ω—ã –∏ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ span'—ã
  const tokens = tokenizePreserve(sentence.danish);
  let wordCounter = 0;
  const partsHtml = tokens.map(t => {
    if(t.isWord){
      const html = `<span class="da-token" data-word-index="${wordCounter}">${escapeHtml(t.text)}</span>`;
      wordCounter++;
      return html;
    } else {
      // –ø—Ä–æ–±–µ–ª—ã –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è ‚Äî —Ç–æ–∂–µ –≤ span –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      return `<span class="da-token" data-word-index="-">${escapeHtml(t.text)}</span>`;
    }
  }).join('');

  el.innerHTML = `${partsHtml}<span class="translation">${escapeHtml(sentence.translation)}</span>`;
  document.getElementById('particleContainer').appendChild(el);
  moveTo(el, randomPosition(el));

  // –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–¥—Å–≤–µ—Ç–∫–∏, –∫–æ—Ç–æ—Ä–∞—è —É–ø—Ä–∞–≤–ª—è–µ—Ç span'–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ el
  const tokenSpans = Array.from(el.querySelectorAll('.da-token'));
  function highlightWord(idx){
    tokenSpans.forEach(s => s.classList.remove('highlight'));
    if(idx === null || idx === undefined) return;
    const target = tokenSpans.find(s => s.dataset.wordIndex === String(idx));
    if(target) target.classList.add('highlight');
  }

  // —Å–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–≤–æ–¥ (—Ä—É—Å—Å–∫–∏–π –æ–¥–∏–Ω –≥–æ–ª–æ—Å) ‚Äî –±–µ–∑ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
  await speakWithPunctuationPauses(sentence.translation, 'ru-RU');

  // –ø–æ—Ç–æ–º –¥–∞—Ç—Å–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –ø–æ–≤—Ç–æ—Ä–æ–º (—á–µ—Ä–µ–¥—É–µ–º –¥–≤–∞ –≥–æ–ª–æ—Å–∞) ‚Äî –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞
  const rates = [0.5, 0.7, 1.0];
  for(let i=0; i<MAX_REPEATS; i++){
    if(i>0) await new Promise(r=>setTimeout(r, 1500));
    moveTo(el, randomPosition(el));
    await speakWithPunctuationPauses(sentence.danish, 'da-DK', rates[Math.min(i,rates.length-1)], true, highlightWord);
  }

  // –û—á–∏—Å—Ç–∏–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∏ —É–¥–∞–ª–∏–º —ç–ª–µ–º–µ–Ω—Ç
  highlightWord(null);
  el.remove();
  showingSentence = false;
}

// ===== –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ —Å –æ–∑–≤—É—á–∫–æ–π –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –±–ª–æ–∫–∞ =====
async function showDialog(dialog){
  const sentences = dialog.dialog;

  // ==== –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê ====
  await speak(`–ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ ${currentIndex+1}`, "ru-RU");

  for(sentenceIndex=0; sentenceIndex<sentences.length; sentenceIndex++){
    // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –°—Ç–æ–ø ‚Äî –ø—Ä–µ—Ä–≤—ë–º –ø—Ä–æ–≥–æ–Ω
    if(!sessionRunning) break;
    await showSentence(sentences[sentenceIndex]);
  }

  // ==== –ö–û–ù–ï–¶ –ë–õ–û–ö–ê ====
  await speak(`–ö–æ–Ω–µ—Ü –¥–∏–∞–ª–æ–≥–∞ ${currentIndex+1}`, "ru-RU");

  sentenceIndex = 0;
  currentIndex = (currentIndex + stepN) % dialogs.length; // —Å–ª–µ–¥—É—é—â–∏–π –¥–∏–∞–ª–æ–≥
}

// ===== START/STOP =====
document.getElementById('startBtn').addEventListener('click', ()=>{
  sessionRunning = true;
  if(!sessionStarted){ sessionStarted = true; startSession(); }
});
document.getElementById('stopBtn').addEventListener('click', ()=>{
  sessionRunning = false;
  // –æ—Å—Ç–∞–Ω–æ–≤–∏–º —Ç–µ–∫—É—â—É—é –æ–∑–≤—É—á–∫—É –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
  try { speechSynthesis.cancel(); } catch(e){}
});

// –∏–∑–º–µ–Ω–µ–Ω–∏–µ —à–∞–≥–∞
document.getElementById('stepBtn').addEventListener('click', ()=>{
  const v = parseInt(document.getElementById('stepInput').value, 10);
  if(!isNaN(v) && v>0) stepN = v;
});

// ===== LOAD FILE =====
document.getElementById('localFileInput').addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = event=>{
    try{
      const data = JSON.parse(event.target.result);
      dialogs = data.map(d => {
        const key = Object.keys(d)[0]; // dialog0, dialog1, ...
        return { dialog: d[key] };
      });
      currentIndex = 0; showingSentence = false;
      console.log("–î–∏–∞–ª–æ–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", file.name);
    }catch(err){
      console.error("–û—à–∏–±–∫–∞:", err);
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON");
    }
  };
  reader.readAsText(file);
});

// ===== LOAD DEFAULT DICTIONARY =====
function loadDictionary(file){
  fetch(file)
    .then(r => r.json())
    .then(data => {
      dialogs = data.map(d => {
        const key = Object.keys(d)[0];
        return { dialog: d[key] };
      });
      currentIndex = 0; showingSentence = false;
      console.log("–î–∏–∞–ª–æ–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞:", file);
    })
    .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤–∞—Ä—è:", err));
}

// ===== SESSION LOOP =====
async function startSession(){
  while(true){
    if(sessionRunning && dialogs.length>0){
      await showDialog(dialogs[currentIndex]);
    } else await new Promise(r=>setTimeout(r,500));
  }
}

loadDictionary('dialogs.json');

window.addEventListener('load', ()=>{
  const controls = document.getElementById('controls'),
        dict = document.getElementById('dictionaryControls');
  controls.offsetHeight; dict.offsetHeight;
  controls.style.visibility = 'visible';
  dict.style.visibility = 'visible';
});

</script>

</body>
</html>
