<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Flashwords</title>

<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  padding: 0;
  font-family: 'Comic Neue', cursive;
  min-height: 100vh;
  overflow: hidden;
  background: linear-gradient(270deg, #1a1a2e, #23233a, #2b2b44, #1f1c2c);
  background-size: 800% 800%;
  animation: gradientBG 70s ease infinite;
}

@keyframes gradientBG {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.particle {
  position: absolute;
  font-weight: bold;
  text-align: center;
  pointer-events: none;
  user-select: none;
  font-size: clamp(2rem, 6vw, 4rem);
  background: linear-gradient(45deg, #ff9a9e, #fad0c4, #ffd700, #6fd6ff, #ff6f61);
  background-size: 400% 400%;
  animation: gradientText 5s ease infinite;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 10px rgba(0,0,0,0.6);
  transition: left 3s ease, top 3s ease;
}

@keyframes gradientText {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.translation {
  display: block;
  font-size: 0.5em;
  margin-top: 0.2em;
  color: #fff;
  text-shadow: 0 0 6px rgba(0,0,0,0.9);
}

/* ===== CONTROLS ===== */
#controls {
  position: fixed;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 8px;
  z-index: 100;
}

#controls input, #controls button {
  background: rgba(0,0,0,0.45);
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  color: #fff;
  font-size: 1rem;
  outline: none;
  text-align: center;
}

#controls input::placeholder {
  color: #bbb;
}

#controls button {
  cursor: pointer;
  transition: 0.2s;
}

#controls button:hover {
  background: rgba(0,0,0,0.65);
}
</style>
</head>

<body>

<div id="controls">
  <input id="searchInput" placeholder="Слово (DA / RU)">
  <button id="searchBtn">OK</button>
  <input id="stepInput" type="number" min="1" value="1" placeholder="N">
  <button id="stepBtn">OK</button>
</div>

<script>
const MAX_REPEATS = 5;

let words = [];
let currentIndex = 0;
let stepN = 1;

/* ===== TTS ===== */
function speak(text, lang, rate = 1) {
  return new Promise(resolve => {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang;
    u.rate = rate;
    u.onend = resolve;
    speechSynthesis.speak(u);
  });
}

/* ===== POSITION ===== */
function randomPosition(el) {
  const x = Math.random() * (window.innerWidth - el.offsetWidth);
  const y = Math.random() * (window.innerHeight - el.offsetHeight - 80);
  return { x, y };
}

function moveTo(el, pos) {
  el.style.left = pos.x + 'px';
  el.style.top = pos.y + 'px';
}

/* ===== WORD DISPLAY ===== */
async function showWord(word) {
  const el = document.createElement('div');
  el.className = 'particle';
  el.innerHTML = `${word.danish}<span class="translation">${word.translation}</span>`;
  document.body.appendChild(el);

  moveTo(el, randomPosition(el));

  // 1-й показ
  await speak(word.translation, 'ru-RU');
  await speak(word.danish, 'da-DK', 0.5);

  const rates = [0.7, 0.9, 1.0];

  for (let i = 1; i < MAX_REPEATS - 1; i++) {
    await new Promise(r => setTimeout(r, 1500));
    moveTo(el, randomPosition(el));
    await speak(word.danish, 'da-DK', rates[Math.min(i - 1, rates.length - 1)]);
  }

  // последний показ
  await new Promise(r => setTimeout(r, 1500));
  moveTo(el, randomPosition(el));
  await speak(word.translation, 'ru-RU');
  await speak(word.danish, 'da-DK', 1.0);

  el.remove();
}

/* ===== INDEX LOGIC ===== */
function nextIndex() {
  currentIndex = (currentIndex + stepN) % words.length;
}

/* ===== SEARCH ===== */
function findWordIndex(query) {
  query = query.toLowerCase().trim();
  return words.findIndex(w =>
    w.danish.toLowerCase() === query ||
    w.translation.toLowerCase() === query
  );
}

/* ===== INPUT HANDLERS ===== */
function handleSearch() {
  const query = document.getElementById('searchInput').value;
  const index = findWordIndex(query);
  if (index !== -1) currentIndex = index;
  document.getElementById('searchInput').value = '';
}

function handleStep() {
  const val = parseInt(document.getElementById('stepInput').value);
  if (val > 0) stepN = val;
}

// кнопки
document.getElementById('searchBtn').addEventListener('click', handleSearch);
document.getElementById('stepBtn').addEventListener('click', handleStep);

// Enter для поиска
document.getElementById('searchInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') handleSearch();
});

// Enter для шага
document.getElementById('stepInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') handleStep();
});

/* ===== SESSION ===== */
async function startSession() {
  while (true) {
    await showWord(words[currentIndex]);
    nextIndex();
  }
}

/* ===== LOAD DICTIONARY ===== */
fetch('dic.json')
  .then(r => r.json())
  .then(data => {
    words = data.map(item => ({
      danish: item.word,
      translation: item.value
    }));
    startSession();
  })
  .catch(err => console.error('Ошибка загрузки dic.json:', err));
</script>

</body>
</html>
